
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant Scolaire - Ollama</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 640 512'><path fill='%23dc2626' d='M320 32c-8.1 0-16.1 1.4-23.7 4.1L15.8 137.4C6.3 140.9 0 149.9 0 160s6.3 19.1 15.8 22.6l57.9 20.9C57.3 229.3 48 259.8 48 291.9v4.9c0 52.7 25.6 99.3 65.1 128.5l-51.4 51.4c-4.1 4.1-5.9 10.1-4.8 15.8C58.1 497.7 62.6 501.9 68 503.4c5.7 1.6 11.6-.1 15.8-4.8l51.4-51.4c29.2 39.5 75.8 65.1 128.5 65.1s99.3-25.6 128.5-65.1l51.4 51.4c4.1 4.1 10.1 5.9 15.8 4.8c5.4-1.5 9.6-5.7 10.8-11.4c1.1-5.7-.7-11.7-4.8-15.8l-51.4-51.4c39.5-29.2 65.1-75.8 65.1-128.5v-4.9c0-32.1-9.3-62.6-25.7-88.4l57.9-20.9c9.5-3.4 15.8-12.5 15.8-22.6s-6.3-19.1-15.8-22.6L343.7 36.1C336.1 33.4 328.1 32 320 32zM128 408c0 35.3 28.7 64 64 64s64-28.7 64-64s-28.7-64-64-64s-64 28.7-64 64zm256-64c-35.3 0-64 28.7-64 64s28.7 64 64 64s64-28.7 64-64s-28.7-64-64-64z'/></svg>" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #dc2626;
            --secondary-color: #1f2937;
            --accent-color: #991b1b;
            --light-color: #f8f9fa;
            --dark-color: #111827;
            --success-color: #059669;
            --warning-color: #d97706;
            --border-radius: 12px;
            --shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.9) 8px, transparent 8px),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.7) 6px, transparent 6px),
                radial-gradient(circle at 40% 40%, rgba(255, 255, 255, 0.8) 7px, transparent 7px),
                radial-gradient(circle at 90% 70%, rgba(255, 255, 255, 0.6) 5px, transparent 5px),
                radial-gradient(circle at 10% 30%, rgba(255, 255, 255, 0.8) 9px, transparent 9px),
                radial-gradient(circle at 60% 90%, rgba(255, 255, 255, 0.7) 6px, transparent 6px),
                linear-gradient(135deg, #dc2626 0%, #991b1b 50%, #7f1d1d 100%);
            background-size: 300px 300px, 250px 250px, 200px 200px, 280px 280px, 220px 220px, 260px 260px, 100% 100%;
            color: var(--dark-color);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
            backdrop-filter: blur(10px);
        }

        .dark-mode-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--light-color);
            border: 2px solid #e2e8f0;
            color: var(--secondary-color);
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            transition: var(--transition);
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dark-mode-btn:hover {
            background: #e2e8f0;
            transform: scale(1.1);
        }

        /* Mode sombre */
        .dark-mode {
            background: 
                radial-gradient(circle at 20% 80%, rgba(100, 100, 150, 0.4) 8px, transparent 8px),
                radial-gradient(circle at 80% 20%, rgba(150, 150, 200, 0.3) 6px, transparent 6px),
                radial-gradient(circle at 40% 40%, rgba(120, 120, 180, 0.35) 7px, transparent 7px),
                radial-gradient(circle at 90% 70%, rgba(140, 140, 190, 0.3) 5px, transparent 5px),
                radial-gradient(circle at 10% 30%, rgba(110, 110, 170, 0.4) 9px, transparent 9px),
                radial-gradient(circle at 60% 90%, rgba(130, 130, 180, 0.3) 6px, transparent 6px),
                linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            background-size: 300px 300px, 250px 250px, 200px 200px, 280px 280px, 220px 220px, 260px 260px, 100% 100%;
            color: #e2e8f0;
        }

        .dark-mode header {
            background: rgba(45, 55, 72, 0.95);
            color: #e2e8f0;
            backdrop-filter: blur(10px);
        }

        .dark-mode h1 {
            color: #ff6b6b;
        }

        .dark-mode .tagline {
            color: #e2e8f0;
        }

        .dark-mode .form-container {
            background: rgba(45, 55, 72, 0.95);
            color: #e2e8f0;
            backdrop-filter: blur(10px);
        }

        .dark-mode .chat-container {
            background: rgba(45, 55, 72, 0.95);
            backdrop-filter: blur(10px);
        }

        .dark-mode .chat-input-container {
            background: rgba(45, 55, 72, 0.95);
            color: #e2e8f0;
        }

        .dark-mode .chat-messages {
            background: 
                radial-gradient(circle at 15% 25%, rgba(100, 100, 150, 0.2) 3px, transparent 3px),
                radial-gradient(circle at 85% 75%, rgba(150, 150, 200, 0.15) 2px, transparent 2px),
                radial-gradient(circle at 45% 60%, rgba(120, 120, 180, 0.12) 2.5px, transparent 2.5px),
                radial-gradient(circle at 70% 30%, rgba(140, 140, 190, 0.1) 2px, transparent 2px),
                linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            background-size: 150px 150px, 120px 120px, 100px 100px, 140px 140px, 100% 100%;
        }

        .dark-mode .ai-message {
            background: #374151;
            border-left-color: var(--primary-color);
            color: #e2e8f0;
        }

        .dark-mode select,
        .dark-mode input {
            background: #374151;
            border-color: #4a5568;
            color: #e2e8f0;
        }

        .dark-mode select:focus,
        .dark-mode input:focus {
            border-color: #ff6b6b;
        }

        .dark-mode label {
            color: #e2e8f0;
        }

        .dark-mode .form-title {
            color: #e2e8f0;
            border-bottom-color: #4a5568;
        }

        .dark-mode .status-bar {
            background: #374151;
            color: #e2e8f0;
        }

        .dark-mode .dark-mode-btn {
            background: #374151;
            border-color: #4a5568;
            color: #e2e8f0;
        }

        .dark-mode .dark-mode-btn:hover {
            background: #4a5568;
        }

        .speak-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 8px;
            transition: var(--transition);
            opacity: 0.8;
            width: auto;
            max-width: none;
            min-width: 32px;
        }

        .speak-btn:hover {
            opacity: 1;
            transform: scale(1.05);
        }

        .speak-btn.speaking {
            background: var(--success-color);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        .voice-controls {
            display: none;
            align-items: center;
            gap: 4px;
            margin-left: 8px;
        }

        .voice-controls.active {
            display: flex;
        }

        .voice-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 4px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            transition: var(--transition);
            width: auto;
            max-width: none;
            margin: 0;
            min-width: 24px;
        }

        .voice-btn:hover {
            background: var(--accent-color);
        }

        .speed-control {
            width: 40px;
            height: 20px;
            font-size: 10px;
            padding: 2px;
            margin: 0 2px;
        }

        .copy-btn {
            background: var(--success-color);
            color: white;
            border: none;
            padding: 6px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 8px;
            transition: var(--transition);
            opacity: 0.8;
            width: auto;
            max-width: none;
            min-width: 32px;
        }

        .copy-btn:hover {
            opacity: 1;
            transform: scale(1.05);
        }

        .copy-btn.copied {
            background: var(--warning-color);
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .tagline {
            color: var(--secondary-color);
            font-size: 1.2rem;
        }

        .status-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
            padding: 10px;
            background: rgba(237, 247, 255, 0.9);
            border-radius: var(--border-radius);
            color: var(--dark-color);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            background-color: var(--success-color);
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-text {
            font-weight: 500;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .form-container {
                padding: 20px;
            }
            
            body {
                padding: 10px;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 2rem;
            }
            
            .tagline {
                font-size: 1rem;
            }
            
            .form-container {
                padding: 15px;
            }
            
            select, input, button {
                padding: 12px;
                font-size: 14px;
            }
        }

        .form-container {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }

        .form-title {
            color: var(--secondary-color);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--secondary-color);
        }

        select, input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.2);
        }

        button {
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
            width: 100%;
            max-width: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }

        button i {
            margin-right: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .chat-container {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 600px;
            min-height: 400px;
            backdrop-filter: blur(10px);
        }
        
        @media (max-width: 768px) {
            .chat-container {
                height: 70vh;
                min-height: 300px;
            }
        }

        .chat-header {
            background: linear-gradient(to right, var(--primary-color), var(--accent-color));
            color: white;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
            width: auto;
            flex-shrink: 0;
        }

        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .chat-header {
                padding: 12px;
                gap: 8px;
            }
            
            .fullscreen-btn {
                padding: 6px;
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .chat-header {
                padding: 10px;
                gap: 6px;
            }
            
            .fullscreen-btn {
                padding: 5px;
                font-size: 13px;
            }
            
            #chat-title {
                font-size: 14px !important;
            }
            
            #chat-title i {
                font-size: 12px !important;
            }
        }

        .chat-only-mode header,
        .chat-only-mode .form-container,
        .chat-only-mode .footer {
            display: none;
        }

        .chat-only-mode {
            padding: 0;
        }

        .chat-only-mode .container {
            max-width: none;
            margin: 0;
            padding: 0;
        }

        .chat-only-mode .main-content {
            grid-template-columns: 1fr;
            gap: 0;
            margin: 0;
        }

        .chat-only-mode .chat-container {
            height: 100vh;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            background: 
                radial-gradient(circle at 15% 25%, rgba(220, 38, 38, 0.1) 3px, transparent 3px),
                radial-gradient(circle at 85% 75%, rgba(220, 38, 38, 0.08) 2px, transparent 2px),
                radial-gradient(circle at 45% 60%, rgba(220, 38, 38, 0.06) 2.5px, transparent 2.5px),
                radial-gradient(circle at 70% 30%, rgba(220, 38, 38, 0.05) 2px, transparent 2px),
                linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            background-size: 150px 150px, 120px 120px, 100px 100px, 140px 140px, 100% 100%;
            min-height: 0;
        }

        .message {
            font-size: 1.08rem;
            margin-bottom: 12px;
            word-break: break-word;
            max-width: 85%;
            padding: 16px 20px;
            border-radius: 18px;
            line-height: 1.7;
            animation: fadeIn 0.3s ease;
            position: relative;
        }
        
        @media (max-width: 768px) {
            .message {
                max-width: 95%;
                padding: 12px 16px;
                font-size: 1rem;
            }
        }
        
        /* Styles pour le formatage Markdown */
        .message h1, .message h2, .message h3 {
            font-weight: bold;
            margin: 16px 0 12px 0;
            color: var(--primary-color);
            line-height: 1.3;
        }

        .dark-mode .message h1, 
        .dark-mode .message h2, 
        .dark-mode .message h3 {
            color: #ff6b6b;
        }
        
        .message h1 {
            font-size: 1.5em;
            text-decoration: underline;
            border-bottom: 3px solid var(--primary-color);
            padding-bottom: 6px;
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .message h2 {
            font-size: 1.3em;
            text-decoration: underline;
            border-left: 4px solid var(--primary-color);
            padding-left: 12px;
            margin-bottom: 12px;
        }
        
        .message h3 {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 10px;
        }
        
        .message strong {
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .message em {
            font-style: italic;
            color: #666;
        }

        .dark-mode .message strong {
            color: #e2e8f0;
        }
        
        .dark-mode .message em {
            color: #cbd5e0;
        }
        
        .message ul, .message ol {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .message li {
            margin: 4px 0;
        }
        
        .message code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #1f2937;
        }

        .dark-mode .message code {
            background: #4a5568;
            color: #e2e8f0;
        }

        .dark-mode .footer {
            color: #e2e8f0;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background-color: var(--primary-color);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .ai-message {
            background-color: #f9fafb;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
            border-left: 3px solid var(--primary-color);
            color: var(--dark-color);
        }

        .message-info {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        .chat-input-container {
            display: flex;
            padding: 15px;
            border-top: 2px solid #e2e8f0;
            background: rgba(255, 255, 255, 0.95);
            flex-shrink: 0;
        }

        .chat-input {
            flex: 1;
            margin-right: 10px;
        }

        #user-input {
            padding: 14px;
            width: 100%;
        }

        #send-btn {
            width: auto;
            max-width: none;
            padding: 14px 20px;
            margin: 0;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 15px;
        }

        .loading-dots {
            display: inline-flex;
            align-items: center;
            color: var(--secondary-color);
            font-weight: 500;
        }

        .dot {
            width: 8px;
            height: 8px;
            background-color: var(--primary-color);
            border-radius: 50%;
            margin: 0 3px;
            animation: bounce 1.5s infinite;
        }

        .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: white;
            font-size: 0.9rem;
        }

        .subject-icon {
            font-size: 1.2rem;
            margin-right: 8px;
            vertical-align: middle;
        }

        /* Styles pour MathJax */
        .message mjx-container {
            font-size: 1.15em !important;
            background: none !important;
            padding: 2px 4px !important;
            margin: 2px 0 !important;
            display: inline-block !important;
        }
        
        .message mjx-container[display="true"] {
            display: block !important;
            text-align: center !important;
            margin: 12px 0 !important;
            padding: 8px 0 !important;
        }
        
        .message .MathJax {
            font-size: 1.1em !important;
        }
        
        /* Amélioration de la lisibilité des formules */
        .ai-message mjx-container {
            background-color: rgba(255, 255, 255, 0.9) !important;
            border-radius: 4px !important;
            border: 1px solid #e5e7eb !important;
            color: #1f2937 !important;
        }

        .dark-mode .ai-message mjx-container {
            background-color: rgba(45, 55, 72, 0.9) !important;
            border: 1px solid #4a5568 !important;
            color: #e2e8f0 !important;
        }

        .dark-mode .message mjx-container {
            color: #e2e8f0 !important;
        }

        .message p {
            margin: 0 0 12px 0;
            text-align: justify;
        }
        
        .message p:last-child {
            margin-bottom: 0;
        }
        
        .message br {
            line-height: 1.4;
        }
        
        /* Espacement amélioré */
        .message ul {
            margin: 12px 0;
            padding-left: 24px;
        }
        
        .message li {
            margin: 6px 0;
            line-height: 1.5;
        }
        
        .message strong {
            font-weight: 700;
            color: var(--secondary-color);
        }
        
        .message em {
            font-style: italic;
            color: #555;
        }
        
        /* Amélioration des paragraphes après titres */
        .message h1 + p,
        .message h2 + p,
        .message h3 + p {
            margin-top: 8px;
        }
        
        /* Styles pour les onglets */
        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }
        
        .tab {
            flex: 1;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: var(--transition);
        }
        
        @media (max-width: 768px) {
            .tab {
                padding: 8px 10px;
                font-size: 13px;
            }
        }
        
        .tab.active {
            background: rgba(255, 255, 255, 0.4);
        }
        
        .tab:first-child {
            border-radius: var(--border-radius) 0 0 0;
        }
        
        .tab:last-child {
            border-radius: 0 var(--border-radius) 0 0;
        }
        
        .tab-content {
            display: none;
            flex: 1;
            flex-direction: column;
            min-height: 0;
        }
        
        .tab-content.active {
            display: flex;
        }
        
        /* Styles pour les flashcards */
        .flashcard-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 400px;
        }
        
        .flashcard {
            width: 100%;
            max-width: 500px;
            height: 250px;
            position: relative;
            perspective: 1000px;
            margin-bottom: 20px;
            transition: opacity 0.2s ease;
        }
        
        .flashcard-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        
        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }
        
        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .flashcard-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .flashcard-back {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            transform: rotateY(180deg);
        }
        
        .flashcard-navigation {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        @media (max-width: 480px) {
            .flashcard-navigation {
                gap: 8px;
            }
        }
        
        .flashcard-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: var(--transition);
            width: auto;
            max-width: none;
            margin: 0;
            white-space: nowrap;
        }
        
        @media (max-width: 768px) {
            .flashcard-btn {
                padding: 6px 10px;
                font-size: 13px;
            }
        }
        
        @media (max-width: 480px) {
            .flashcard-btn {
                padding: 5px 8px;
                font-size: 12px;
            }
        }
        
        .flashcard-btn:hover {
            background: var(--accent-color);
            transform: translateY(-2px);
        }
        
        .flashcard-counter {
            font-weight: 500;
            font-size: 14px;
            color: var(--secondary-color);
            min-width: 50px;
            text-align: center;
        }
        
        @media (max-width: 480px) {
            .flashcard-counter {
                font-size: 13px;
                min-width: 45px;
            }
        }
        
        .dark-mode .flashcard-counter {
            color: #e2e8f0;
        }
        
        .flashcard-loading {
            text-align: center;
            padding: 40px;
            color: var(--secondary-color);
        }
        
        .dark-mode .flashcard-loading {
            color: #e2e8f0;
        }
        
        /* Styles MathJax pour les flashcards */
        .flashcard-front mjx-container,
        .flashcard-back mjx-container {
            font-size: 1.2em !important;
            color: white !important;
            background: rgba(255,255,255,0.1) !important;
            border-radius: 6px !important;
            border: 1px solid #fff !important;
            padding: 4px 8px !important;
        }
        
        .flashcard-front mjx-container[display="true"],
        .flashcard-back mjx-container[display="true"] {
            display: block !important;
            text-align: center !important;
            margin: 8px 0 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <button class="dark-mode-btn" id="lang-btn" title="Langue" style="right: 75px;">
                <i class="fas fa-language"></i>
            </button>
            <button class="dark-mode-btn" id="dark-mode-btn" title="Mode nuit">
                <i class="fas fa-moon"></i>
            </button>
            <h1><i class="fas fa-graduation-cap"></i> Assistant Scolaire</h1>
            <p class="tagline">Obtenez de l'aide dans vos matières scolaires grâce à l'IA Ollama</p>
            <div class="status-bar" id="status-bar">
                <div class="status-indicator" id="status-indicator"></div>
                <div class="status-text" id="status-text">Vérification de la connexion...</div>
            </div>
            

        </header>
        
        <div class="main-content">
            <div class="form-container">
                <h2 class="form-title"><i class="fas fa-cog"></i> Configuration</h2>
                <div class="form-group">
                    <label for="level"><i class="fas fa-graduation-cap subject-icon"></i> Niveau scolaire</label>
                    <select id="level">
                        <option value="">Sélectionnez votre niveau</option>
                        <option value="6eme">6ème</option>
                        <option value="5eme">5ème</option>
                        <option value="4eme">4ème</option>
                        <option value="3eme">3ème</option>
                        <option value="seconde">Seconde</option>
                        <option value="premiere">Première</option>
                        <option value="terminale">Terminale</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="subject"><i class="fas fa-book subject-icon"></i> Matière scolaire</label>
                    <select id="subject" disabled>
                        <option value="">Sélectionnez d'abord votre niveau</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="chapter"><i class="fas fa-file-alt subject-icon"></i> Chapitre</label>
                    <input type="text" id="chapter" placeholder="Ex: Révolution française, Fonctions exponentielles...">
                </div>
                
                <div class="form-group">
                    <label for="option"><i class="fas fa-hands-helping subject-icon"></i> Type d'aide</label>
                    <select id="option">
                        <option value="">Sélectionnez une option</option>
                        <option value="comprendre">Comprendre le chapitre</option>
                        <option value="devoir">Aide aux devoirs</option>
                        <option value="exercice">Exercices supplémentaires</option>
                        <option value="revision">Révision et synthèse</option>
                        <option value="explication">Explication détaillée</option>
                    </select>
                </div>
                
                <button id="start-btn">
                    <i class="fas fa-comments"></i> Démarrer la conversation
                </button>
            </div>
            
            <div class="chat-container" id="chat-container">
                <div class="chat-header">
                    <div class="tabs">
                        <button class="tab active" id="chat-tab"><i class="fas fa-comment-dots"></i> Discussion</button>
                        <button class="tab" id="flashcard-tab"><i class="fas fa-layer-group"></i> Flashcards</button>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 15px; background: linear-gradient(to right, var(--primary-color), var(--accent-color)); color: white;">
                    <h3 id="chat-title" style="font-size: 16px; margin: 0; font-weight: 500;"><i class="fas fa-comment-dots" style="font-size: 14px; margin-right: 6px;"></i> Discussion</h3>
                    <div style="display: flex; gap: 8px;">
                        <button class="fullscreen-btn" id="refresh-btn" title="Rafraîchir la discussion">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button class="fullscreen-btn" id="fullscreen-btn" title="Mode discussion seule">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Contenu Discussion -->
                <div class="tab-content active" id="chat-content">
                    <div class="chat-messages" id="chat-messages">
                        <div class="message ai-message">
                            Bonjour ! Je suis votre assistant scolaire. Veuillez sélectionner une matière, un chapitre et le type d'aide dont vous avez besoin pour commencer.
                            <div class="message-info">Assistant Ollama</div>
                        </div>
                    </div>
                    
                    <div class="loading" id="loading">
                        <div class="loading-dots">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span>Ollama réfléchit</span>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <div class="chat-input">
                            <input type="text" id="user-input" placeholder="Posez votre question..." disabled>
                        </div>
                        <button id="send-btn" disabled><i class="fas fa-paper-plane"></i> Envoyer</button>
                    </div>
                </div>
                
                <!-- Contenu Flashcards -->
                <div class="tab-content" id="flashcard-content">
                    <div class="flashcard-container">
                        <div class="flashcard-loading" id="flashcard-loading">
                            <i class="fas fa-spinner fa-spin"></i> Génération des flashcards...
                        </div>
                        
                        <div class="flashcard" id="flashcard" style="display: none;">
                            <div class="flashcard-inner">
                                <div class="flashcard-front">
                                    <p id="flashcard-question">Question</p>
                                </div>
                                <div class="flashcard-back">
                                    <p id="flashcard-answer">Réponse</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flashcard-navigation" id="flashcard-nav" style="display: none;">
                            <button class="flashcard-btn" id="prev-flashcard">
                                <i class="fas fa-chevron-left"></i> Précédente
                            </button>
                            <span class="flashcard-counter" id="flashcard-counter">1 / 10</span>
                            <button class="flashcard-btn" id="next-flashcard">
                                Suivante <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p id="footer-text">Assistant Scolaire - Llama 3</p>
            <p style="font-size: 0.8rem; margin-top: 5px; opacity: 0.7;">Mode local (Ollama) | Cloud (Groq) | Site Web (Lecointre David)</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const levelSelect = document.getElementById('level');
            const subjectSelect = document.getElementById('subject');
            const chapterInput = document.getElementById('chapter');
            const optionSelect = document.getElementById('option');
            const startBtn = document.getElementById('start-btn');
            const chatContainer = document.getElementById('chat-container');
            const chatMessages = document.getElementById('chat-messages');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const loading = document.getElementById('loading');
            const chatTitle = document.getElementById('chat-title');
            
            let conversationHistory = [];
            let currentContext = {};
            let apiMode = 'ollama'; // 'ollama', 'groq'
            const groqKey = 'gsk_VQgKJxWzBvFhYQGJxWzBvFhYQGJxWzBvFhYQGJxWzBvFhYQGJxWzBvFhYQ';
            let openaiKey = localStorage.getItem('openai_key') || '';
            let currentLanguage = localStorage.getItem('language') || 'fr'; // 'fr' ou 'en'
            
            // Traductions
            const translations = {
                fr: {
                    title: 'Assistant Scolaire',
                    tagline: 'Obtenez de l\'aide dans vos matières scolaires grâce à l\'IA Ollama',
                    config: 'Configuration',
                    level: 'Niveau scolaire',
                    selectLevel: 'Sélectionnez votre niveau',
                    subject: 'Matière scolaire',
                    selectSubject: 'Sélectionnez d\'abord votre niveau',
                    chapter: 'Chapitre',
                    chapterPlaceholder: 'Ex: Révolution française, Fonctions exponentielles...',
                    helpType: 'Type d\'aide',
                    selectOption: 'Sélectionnez une option',
                    understand: 'Comprendre le chapitre',
                    homework: 'Aide aux devoirs',
                    exercises: 'Exercices supplémentaires',
                    revision: 'Révision et synthèse',
                    explanation: 'Explication détaillée',
                    startConversation: 'Démarrer la conversation',
                    discussion: 'Discussion',
                    flashcards: 'Flashcards',
                    refresh: 'Rafraîchir la discussion',
                    fullscreen: 'Mode discussion seule',
                    askQuestion: 'Posez votre question...',
                    send: 'Envoyer',
                    you: 'Vous',
                    generating: 'Génération des flashcards...',
                    previous: 'Précédente',
                    next: 'Suivante',
                    welcomeMessage: 'Bonjour ! Je suis votre assistant scolaire. Veuillez sélectionner une matière, un chapitre et le type d\'aide dont vous avez besoin pour commencer.',
                    assistantName: 'Assistant Ollama'
                },
                en: {
                    title: 'School Assistant',
                    tagline: 'Get help with your school subjects using Ollama AI',
                    config: 'Configuration',
                    level: 'School Level',
                    selectLevel: 'Select your level',
                    subject: 'School Subject',
                    selectSubject: 'Select your level first',
                    chapter: 'Chapter',
                    chapterPlaceholder: 'Ex: French Revolution, Exponential Functions...',
                    helpType: 'Help Type',
                    selectOption: 'Select an option',
                    understand: 'Understand the chapter',
                    homework: 'Homework help',
                    exercises: 'Additional exercises',
                    revision: 'Review and synthesis',
                    explanation: 'Detailed explanation',
                    startConversation: 'Start conversation',
                    discussion: 'Discussion',
                    flashcards: 'Flashcards',
                    refresh: 'Refresh discussion',
                    fullscreen: 'Discussion only mode',
                    askQuestion: 'Ask your question...',
                    send: 'Send',
                    you: 'You',
                    generating: 'Generating flashcards...',
                    previous: 'Previous',
                    next: 'Next',
                    welcomeMessage: 'Hello! I am your school assistant. Please select a subject, a chapter and the type of help you need to get started.',
                    assistantName: 'Ollama Assistant'
                }
            };
            
            function updateInterface() {
                const t = translations[currentLanguage];
                
                // Header
                document.querySelector('h1').innerHTML = `<i class="fas fa-graduation-cap"></i> ${t.title}`;
                document.querySelector('.tagline').textContent = t.tagline;
                
                // Configuration
                document.querySelector('.form-title').innerHTML = `<i class="fas fa-cog"></i> ${t.config}`;
                document.querySelector('label[for="level"]').innerHTML = `<i class="fas fa-graduation-cap subject-icon"></i> ${t.level}`;
                document.querySelector('label[for="subject"]').innerHTML = `<i class="fas fa-book subject-icon"></i> ${t.subject}`;
                document.querySelector('label[for="chapter"]').innerHTML = `<i class="fas fa-file-alt subject-icon"></i> ${t.chapter}`;
                document.querySelector('label[for="option"]').innerHTML = `<i class="fas fa-hands-helping subject-icon"></i> ${t.helpType}`;
                
                // Options
                document.querySelector('#level option[value=""]').textContent = t.selectLevel;
                document.querySelector('#subject option[value=""]').textContent = t.selectSubject;
                document.querySelector('#chapter').placeholder = t.chapterPlaceholder;
                document.querySelector('#option option[value=""]').textContent = t.selectOption;
                document.querySelector('#option option[value="comprendre"]').textContent = t.understand;
                document.querySelector('#option option[value="devoir"]').textContent = t.homework;
                document.querySelector('#option option[value="exercice"]').textContent = t.exercises;
                document.querySelector('#option option[value="revision"]').textContent = t.revision;
                document.querySelector('#option option[value="explication"]').textContent = t.explanation;
                
                // Boutons
                document.querySelector('#start-btn').innerHTML = `<i class="fas fa-comments"></i> ${t.startConversation}`;
                document.querySelector('#chat-tab').innerHTML = `<i class="fas fa-comment-dots"></i> ${t.discussion}`;
                document.querySelector('#flashcard-tab').innerHTML = `<i class="fas fa-layer-group"></i> ${t.flashcards}`;
                document.querySelector('#chat-title').innerHTML = `<i class="fas fa-comment-dots"></i> ${t.discussion}`;
                document.querySelector('#refresh-btn').title = t.refresh;
                document.querySelector('#fullscreen-btn').title = t.fullscreen;
                document.querySelector('#user-input').placeholder = t.askQuestion;
                document.querySelector('#send-btn').innerHTML = `<i class="fas fa-paper-plane"></i> ${t.send}`;
                
                // Flashcards
                document.querySelector('#prev-flashcard').innerHTML = `<i class="fas fa-chevron-left"></i> ${t.previous}`;
                document.querySelector('#next-flashcard').innerHTML = `${t.next} <i class="fas fa-chevron-right"></i>`;
                
                // Message d'accueil
                const welcomeMsg = document.querySelector('.ai-message');
                if (welcomeMsg && welcomeMsg.textContent.includes('Bonjour !') || welcomeMsg.textContent.includes('Hello!')) {
                    welcomeMsg.innerHTML = `${t.welcomeMessage}<div class="message-info">${t.assistantName}</div>`;
                }
            }
            
            // Variables pour les flashcards
            let flashcards = [];
            let currentFlashcardIndex = 0;
            let flashcardsGenerated = false;
            
            // Matières par niveau (définir avant loadPreferences)
            const subjectsByLevel = {
                '6eme': [
                    {value: 'mathematiques', text: 'Mathématiques'},
                    {value: 'francais', text: 'Français'},
                    {value: 'histoire_geographie', text: 'Histoire-Géographie'},
                    {value: 'anglais', text: 'Anglais'},
                    {value: 'svt', text: 'SVT'},
                    {value: 'technologie', text: 'Technologie'},
                    {value: 'arts_plastiques', text: 'Arts plastiques'},
                    {value: 'education_musicale', text: 'Éducation musicale'},
                    {value: 'eps', text: 'EPS'}
                ],
                '5eme': [
                    {value: 'mathematiques', text: 'Mathématiques'},
                    {value: 'francais', text: 'Français'},
                    {value: 'histoire_geographie', text: 'Histoire-Géographie'},
                    {value: 'anglais', text: 'Anglais'},
                    {value: 'svt', text: 'SVT'},
                    {value: 'physique_chimie', text: 'Physique-Chimie'},
                    {value: 'technologie', text: 'Technologie'},
                    {value: 'arts_plastiques', text: 'Arts plastiques'},
                    {value: 'education_musicale', text: 'Éducation musicale'},
                    {value: 'eps', text: 'EPS'}
                ],
                '4eme': [
                    {value: 'mathematiques', text: 'Mathématiques'},
                    {value: 'francais', text: 'Français'},
                    {value: 'histoire_geographie', text: 'Histoire-Géographie'},
                    {value: 'anglais', text: 'Anglais'},
                    {value: 'svt', text: 'SVT'},
                    {value: 'physique_chimie', text: 'Physique-Chimie'},
                    {value: 'technologie', text: 'Technologie'},
                    {value: 'arts_plastiques', text: 'Arts plastiques'},
                    {value: 'education_musicale', text: 'Éducation musicale'},
                    {value: 'eps', text: 'EPS'}
                ],
                '3eme': [
                    {value: 'mathematiques', text: 'Mathématiques'},
                    {value: 'francais', text: 'Français'},
                    {value: 'histoire_geographie', text: 'Histoire-Géographie'},
                    {value: 'anglais', text: 'Anglais'},
                    {value: 'svt', text: 'SVT'},
                    {value: 'physique_chimie', text: 'Physique-Chimie'},
                    {value: 'technologie', text: 'Technologie'},
                    {value: 'arts_plastiques', text: 'Arts plastiques'},
                    {value: 'education_musicale', text: 'Éducation musicale'},
                    {value: 'eps', text: 'EPS'}
                ],
                'seconde': [
                    {value: 'mathematiques', text: 'Mathématiques'},
                    {value: 'francais', text: 'Français'},
                    {value: 'histoire_geographie', text: 'Histoire-Géographie'},
                    {value: 'anglais', text: 'Anglais'},
                    {value: 'svt', text: 'SVT'},
                    {value: 'physique_chimie', text: 'Physique-Chimie'},
                    {value: 'ses', text: 'SES'},
                    {value: 'eps', text: 'EPS'}
                ],
                'premiere': [
                    {value: 'francais', text: 'Français'},
                    {value: 'histoire_geographie', text: 'Histoire-Géographie'},
                    {value: 'anglais', text: 'Anglais'},
                    {value: 'enseignement_scientifique', text: 'Enseignement scientifique'},
                    {value: 'eps', text: 'EPS'},
                    {value: 'specialite_mathematiques', text: 'Spé. Mathématiques'},
                    {value: 'specialite_physique_chimie', text: 'Spé. Physique-Chimie'},
                    {value: 'specialite_svt', text: 'Spé. SVT'},
                    {value: 'specialite_ses', text: 'Spé. SES'},
                    {value: 'specialite_hggsp', text: 'Spé. HGGSP'},
                    {value: 'specialite_hlp', text: 'Spé. HLP'},
                    {value: 'specialite_llcer', text: 'Spé. LLCER'},
                    {value: 'specialite_nsi', text: 'Spé. NSI'}
                ],
                'terminale': [
                    {value: 'philosophie', text: 'Philosophie'},
                    {value: 'histoire_geographie', text: 'Histoire-Géographie'},
                    {value: 'anglais', text: 'Anglais'},
                    {value: 'enseignement_scientifique', text: 'Enseignement scientifique'},
                    {value: 'eps', text: 'EPS'},
                    {value: 'specialite_mathematiques', text: 'Spé. Mathématiques'},
                    {value: 'specialite_physique_chimie', text: 'Spé. Physique-Chimie'},
                    {value: 'specialite_svt', text: 'Spé. SVT'},
                    {value: 'specialite_ses', text: 'Spé. SES'},
                    {value: 'specialite_hggsp', text: 'Spé. HGGSP'},
                    {value: 'specialite_hlp', text: 'Spé. HLP'},
                    {value: 'specialite_llcer', text: 'Spé. LLCER'},
                    {value: 'specialite_nsi', text: 'Spé. NSI'}
                ]
            };
            
            // Restaurer les préférences sauvegardées
            loadPreferences();
            
            // Vérifier la disponibilité d'Ollama au chargement
            checkOllamaAvailability();
            
            // Sauvegarder les préférences et arrêter la lecture avant de quitter
            window.addEventListener('beforeunload', function() {
                speechSynthesis.cancel();
                savePreferences();
            });
            
            // Arrêter la lecture lors du rechargement de la page
            window.addEventListener('pagehide', function() {
                speechSynthesis.cancel();
            });
            
            function savePreferences() {
                const preferences = {
                    level: levelSelect.value,
                    subject: subjectSelect.value,
                    chapter: chapterInput.value,
                    option: optionSelect.value
                };
                localStorage.setItem('schoolOllama_preferences', JSON.stringify(preferences));
            }
            
            function loadPreferences() {
                const saved = localStorage.getItem('schoolOllama_preferences');
                if (saved) {
                    const preferences = JSON.parse(saved);
                    if (preferences.level) {
                        levelSelect.value = preferences.level;
                        
                        // Débloquer manuellement les matières
                        const selectedLevel = preferences.level;
                        subjectSelect.innerHTML = '<option value="">Sélectionnez une matière</option>';
                        if (selectedLevel && subjectsByLevel[selectedLevel]) {
                            subjectSelect.disabled = false;
                            subjectsByLevel[selectedLevel].forEach(subject => {
                                const option = document.createElement('option');
                                option.value = subject.value;
                                option.textContent = subject.text;
                                subjectSelect.appendChild(option);
                            });
                        }
                        
                        // Restaurer les autres valeurs
                        if (preferences.subject) subjectSelect.value = preferences.subject;
                        if (preferences.chapter) chapterInput.value = preferences.chapter;
                        if (preferences.option) optionSelect.value = preferences.option;
                    }
                }
            }
            
            async function checkOllamaAvailability() {
                const statusIndicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');
                
                if (!statusIndicator || !statusText) {
                    console.error('Éléments de statut non trouvés');
                    return;
                }
                
                // Vérifier si on est sur file:// (ouverture directe du fichier)
                if (window.location.protocol === 'file:') {
                    statusIndicator.style.backgroundColor = '#ff6b35';
                    statusText.textContent = 'Llama 3 (Groq) activé automatiquement';
                    apiMode = 'groq';
                    return;
                }
                
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000);
                    
                    const response = await fetch('http://localhost:11434/api/tags', {
                        method: 'GET',
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (response.ok) {
                        statusIndicator.style.backgroundColor = 'var(--success-color)';
                        statusText.textContent = 'Connecté à Ollama (local)';
                        apiMode = 'ollama';
                    } else {
                        throw new Error('Ollama non accessible');
                    }
                } catch (error) {
                    console.log('Ollama non détecté:', error.message);
                    // Activer automatiquement Groq
                    apiMode = 'groq';
                    statusIndicator.style.backgroundColor = '#ff6b35';
                    statusText.textContent = 'Llama 3 (Groq) activé automatiquement';
                }
            }
            

            
            // Gestion du bouton de rafraîchissement
            const refreshBtn = document.getElementById('refresh-btn');
            
            refreshBtn.addEventListener('click', function() {
                const t = translations[currentLanguage];
                
                // Arrêter toute lecture en cours
                speechSynthesis.cancel();
                isPaused = false;
                
                // Vider l'historique de conversation
                conversationHistory = [];
                
                // Vider les messages du chat
                chatMessages.innerHTML = `<div class="message ai-message">${t.welcomeMessage}<div class="message-info">${t.assistantName}</div></div>`;
                
                // Désactiver les champs de saisie
                userInput.disabled = true;
                sendBtn.disabled = true;
                userInput.value = '';
                
                // Réinitialiser les flashcards avec message de chargement
                flashcards = [];
                currentFlashcardIndex = 0;
                flashcardsGenerated = false;
                document.getElementById('flashcard-loading').style.display = 'block';
                document.getElementById('flashcard').style.display = 'none';
                document.getElementById('flashcard-nav').style.display = 'none';
                document.getElementById('flashcard-loading').innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${t.generating}`;
                
                // Revenir à l'onglet discussion
                chatTab.classList.add('active');
                flashcardTab.classList.remove('active');
                chatContent.classList.add('active');
                flashcardContent.classList.remove('active');
            });
            
            // Gestion du mode chat seul
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            let isChatOnly = false;
            
            fullscreenBtn.addEventListener('click', function() {
                if (!isChatOnly) {
                    document.body.classList.add('chat-only-mode');
                    fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                    fullscreenBtn.title = 'Afficher tout';
                    isChatOnly = true;
                } else {
                    document.body.classList.remove('chat-only-mode');
                    fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                    fullscreenBtn.title = 'Mode discussion seule';
                    isChatOnly = false;
                }
            });
            
            // Gestion des onglets
            const chatTab = document.getElementById('chat-tab');
            const flashcardTab = document.getElementById('flashcard-tab');
            const chatContent = document.getElementById('chat-content');
            const flashcardContent = document.getElementById('flashcard-content');
            
            chatTab.addEventListener('click', function() {
                chatTab.classList.add('active');
                flashcardTab.classList.remove('active');
                chatContent.classList.add('active');
                flashcardContent.classList.remove('active');
            });
            
            flashcardTab.addEventListener('click', function() {
                flashcardTab.classList.add('active');
                chatTab.classList.remove('active');
                flashcardContent.classList.add('active');
                chatContent.classList.remove('active');
                
                // Générer les flashcards si pas encore fait et si on a un contexte
                if (!flashcardsGenerated && currentContext && currentContext.subject && currentContext.chapter) {
                    generateFlashcards();
                } else if (!currentContext || !currentContext.subject || !currentContext.chapter) {
                    // Garder le message de chargement jusqu'à nouvelle conversation
                    const loadingElement = document.getElementById('flashcard-loading');
                    const t = translations[currentLanguage];
                    if (loadingElement) {
                        loadingElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${t.generating}`;
                        loadingElement.style.display = 'block';
                        document.getElementById('flashcard').style.display = 'none';
                        document.getElementById('flashcard-nav').style.display = 'none';
                    }
                }
            });
            
            // Gestion de la langue
            const langBtn = document.getElementById('lang-btn');
            
            function updateLanguageButton() {
                if (currentLanguage === 'fr') {
                    langBtn.innerHTML = '<span style="font-size: 14px; font-weight: bold;">FR</span>';
                    langBtn.title = 'Passer en anglais';
                } else {
                    langBtn.innerHTML = '<span style="font-size: 14px; font-weight: bold;">EN</span>';
                    langBtn.title = 'Switch to French';
                }
            }
            
            updateLanguageButton();
            
            langBtn.addEventListener('click', function() {
                currentLanguage = currentLanguage === 'fr' ? 'en' : 'fr';
                localStorage.setItem('language', currentLanguage);
                updateLanguageButton();
                updateInterface();
            });
            
            // Initialiser l'interface dans la bonne langue
            updateInterface();
            
            // Gestion du mode nuit
            const darkModeBtn = document.getElementById('dark-mode-btn');
            let isDarkMode = localStorage.getItem('darkMode') === 'true';
            
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeBtn.innerHTML = '<i class="fas fa-sun"></i>';
                darkModeBtn.title = 'Mode jour';
            }
            
            darkModeBtn.addEventListener('click', function() {
                if (!isDarkMode) {
                    document.body.classList.add('dark-mode');
                    darkModeBtn.innerHTML = '<i class="fas fa-sun"></i>';
                    darkModeBtn.title = 'Mode jour';
                    localStorage.setItem('darkMode', 'true');
                    isDarkMode = true;
                } else {
                    document.body.classList.remove('dark-mode');
                    darkModeBtn.innerHTML = '<i class="fas fa-moon"></i>';
                    darkModeBtn.title = 'Mode nuit';
                    localStorage.setItem('darkMode', 'false');
                    isDarkMode = false;
                }
            });
            
            // Gestion des flashcards
            const flashcardElement = document.getElementById('flashcard');
            const prevBtn = document.getElementById('prev-flashcard');
            const nextBtn = document.getElementById('next-flashcard');
            const flashcardCounter = document.getElementById('flashcard-counter');
            
            // Retourner la flashcard
            flashcardElement.addEventListener('click', function() {
                flashcardElement.classList.toggle('flipped');
                const answerElement = document.getElementById('flashcard-answer');
                setTimeout(() => {
                    if (flashcardElement.classList.contains('flipped')) {
                        answerElement.style.visibility = 'visible';
                    } else {
                        answerElement.style.visibility = 'hidden';
                    }
                }, 600); // durée de la transition CSS
            });
            
            // Navigation flashcards
            prevBtn.addEventListener('click', function() {
                if (currentFlashcardIndex > 0) {
                    currentFlashcardIndex--;
                    updateFlashcard();
                }
            });
            
            nextBtn.addEventListener('click', function() {
                if (currentFlashcardIndex < flashcards.length - 1) {
                    currentFlashcardIndex++;
                    updateFlashcard();
                }
            });
            

            
            function fixLatexInJsonString(jsonStr) {
                // Corrige les commandes LaTeX mal formées dans tout le JSON
                return jsonStr
                    // Corrige les commandes LaTeX courantes
                    .replace(/([^\\])int\b/g, '$1\\int')
                    .replace(/([^\\])cdot\b/g, '$1\\cdot')
                    .replace(/([^\\])mathbf\{/g, '$1\\mathbf{')
                    .replace(/([^\\])frac\{/g, '$1\\frac{')
                    .replace(/([^\\])sqrt\{/g, '$1\\sqrt{')
                    .replace(/([^\\])Delta\b/g, '$1\\Delta')
                    .replace(/([^\\])propto\b/g, '$1\\propto')
                    // Ajoute d'autres corrections si besoin
                    ;
            }

            function updateFlashcard() {
                if (flashcards.length > 0) {
                    const flashcard = flashcards[currentFlashcardIndex];
                    const questionElement = document.getElementById('flashcard-question');
                    const answerElement = document.getElementById('flashcard-answer');
                    const flashcardEl = document.getElementById('flashcard');

                    // UTILISER EXACTEMENT LA MÊME MÉTHODE QUE displayMessage()
                    const formattedQuestion = formatMessage(flashcard.question);
                    const formattedAnswer = formatMessage(flashcard.answer);

                    questionElement.innerHTML = formattedQuestion;
                    answerElement.innerHTML = formattedAnswer;
                    flashcardCounter.textContent = `${currentFlashcardIndex + 1} / ${flashcards.length}`;

                    // Toujours revenir à la face question
                    flashcardEl.classList.remove('flipped');
                    answerElement.style.visibility = 'hidden';

                    // MÊME RENDU MathJax QUE displayMessage()
                    setTimeout(() => {
                        if (window.MathJax && window.MathJax.typesetPromise) {
                            window.MathJax.typesetPromise([questionElement, answerElement]).catch((err) => {
                                console.warn('Erreur MathJax flashcard:', err);
                            });
                        }
                    }, 100);
                }
            }
            
            async function generateFlashcards() {
                const loadingElement = document.getElementById('flashcard-loading');
                const flashcardElement = document.getElementById('flashcard');
                const navElement = document.getElementById('flashcard-nav');
                
                loadingElement.style.display = 'block';
                flashcardElement.style.display = 'none';
                navElement.style.display = 'none';
                
                try {
                    const langInstruction = currentLanguage === 'fr' ? 
                        'Crée exactement 25 flashcards EN FRANÇAIS' : 
                        'Create exactly 25 flashcards IN ENGLISH';
                    
                    let mathInstructions = '';
                    if (currentContext.subject.includes('mathematiques') || currentContext.subject.includes('physique') || currentContext.subject.includes('scientifique')) {
                        mathInstructions = `

Pour les formules mathematiques :
- Utilise des formules simples
- Encadre avec $ comme : $f(x) = ax + b$
- Evite les caracteres speciaux complexes`;
                    }
                    
                    // Générer un seed aléatoire pour varier les flashcards
                    const randomSeed = Math.floor(Math.random() * 1000);
                    const randomPrompts = [
                        "Varie les angles d'approche et les formulations.",
                        "Explore différents aspects du chapitre.",
                        "Concentre-toi sur des détails spécifiques.",
                        "Aborde les applications concrètes.",
                        "Focus sur les difficultés d'apprentissage."
                    ];
                    const randomHint = randomPrompts[randomSeed % randomPrompts.length];
                    
                    const isMathSubject = currentContext.subject.includes('mathematiques') || currentContext.subject.includes('physique') || currentContext.subject.includes('scientifique');
                    
                    const prompt = `Tu es un professeur agrégé de ${currentContext.subject} spécialisé dans la création de flashcards pédagogiques pour le niveau ${currentContext.level}.

EXIGENCE ABSOLUE DE PRECISION ACADEMIQUE:
- Vérifie mentalement chaque fait, date, nom propre et définition avant de l'écrire
- Utilise UNIQUEMENT des informations issues des manuels scolaires officiels
- En cas de doute sur une information, ne l'inclus PAS dans les flashcards
- Respecte scrupuleusement la terminologie du programme officiel
- Vérifie la chronologie et ne confonds jamais les époques

${langInstruction} pour le chapitre "${currentContext.chapter}" niveau ${currentContext.level}.

CONSIGNES STRICTES POUR LES FLASHCARDS:
1. Crée EXACTEMENT 25 flashcards de qualité académique
2. Questions précises et factuelles sur ${currentContext.chapter}
3. Réponses courtes, exactes et vérifiables
4. Niveau de difficulté adapté au ${currentContext.level}
5. ${isMathSubject ? 'Formules en LaTeX avec $...$' : 'Terminologie française exclusive'}
6. Pas d'approximations ni de généralités vagues

FORMAT OBLIGATOIRE - Réponds UNIQUEMENT avec ce JSON valide:
[{"question": "Question précise?", "answer": "Réponse exacte et vérifiée"}]

ATTENTION: Aucune erreur factuelle n'est tolérée. Ces flashcards seront utilisées pour l'apprentissage scolaire.`;

                    let response;
                    if (apiMode === 'ollama') {
                        response = await callOllamaForFlashcards(prompt);
                    } else {
                        response = await callGroqForFlashcards(prompt);
                    }

                    let cleanResponse = response.trim();
                    
                    // Extraire le JSON même s'il y a du texte avant/après
                    const jsonMatch = cleanResponse.match(/\[\s*\{[\s\S]*?\}\s*\]/s);
                    if (jsonMatch) {
                        cleanResponse = jsonMatch[0];
                    } else {
                        // Chercher un début de tableau JSON
                        const startIndex = cleanResponse.indexOf('[{');
                        const endIndex = cleanResponse.lastIndexOf('}]');
                        if (startIndex !== -1 && endIndex !== -1 && endIndex > startIndex) {
                            cleanResponse = cleanResponse.substring(startIndex, endIndex + 2);
                        }
                    }

                    // Nettoyage JSON ultra-robuste
                    cleanResponse = cleanResponse
                        .replace(/\\n/g, ' ')
                        .replace(/\\t/g, ' ')
                        .replace(/\s+/g, ' ')
                        .trim();
                    
                    // Supprimer toutes les virgules orphelines
                    cleanResponse = cleanResponse
                        .replace(/\[\s*,+\s*/g, '[')
                        .replace(/,+\s*\]/g, ']')
                        .replace(/,+\s*\}/g, '}')
                        .replace(/\{\s*,+\s*/g, '{')
                        .replace(/,+\s*,+/g, ',')
                        .replace(/\}\s*,+\s*\{/g, '}, {')
                        // Nettoyer les chaînes
                        .replace(/"([^"]*)"/g, (match, content) => {
                            return '"' + content.replace(/"/g, "'").replace(/\n/g, ' ').replace(/\r/g, ' ') + '"';
                        });

                    try {
                        // Tentative de parsing avec validation
                        let parsedData = JSON.parse(cleanResponse);
                        
                        if (!Array.isArray(parsedData)) {
                            throw new Error('Format invalide - pas un tableau');
                        }
                        
                        // Valider chaque flashcard
                        flashcards = parsedData.filter(card => 
                            card && 
                            typeof card === 'object' && 
                            card.question && 
                            card.answer &&
                            typeof card.question === 'string' &&
                            typeof card.answer === 'string'
                        ).slice(0, 25); // Limiter à 25
                        
                        if (flashcards.length < 10) {
                            throw new Error(`Seulement ${flashcards.length} flashcards valides générées`);
                        }
                        
                    } catch (parseError) {
                        console.error('Erreur parsing JSON:', parseError);
                        console.log('JSON problématique:', cleanResponse.substring(0, 500) + '...');
                        
                        // Tentative de récupération avec regex améliorée
                        try {
                            // Extraire chaque objet flashcard individuellement
                            const matches = cleanResponse.match(/\{[^{}]*"question"[^{}]*"answer"[^{}]*\}/g);
                            if (matches && matches.length >= 5) {
                                flashcards = [];
                                for (let match of matches.slice(0, 25)) {
                                    try {
                                        // Nettoyer chaque objet individuellement
                                        let cleanMatch = match
                                            .replace(/,+\s*\}/g, '}')
                                            .replace(/\{\s*,+/g, '{')
                                            .replace(/,+\s*,+/g, ',');
                                        const parsed = JSON.parse(cleanMatch);
                                        if (parsed.question && parsed.answer) {
                                            flashcards.push(parsed);
                                        }
                                    } catch (e) {
                                        console.log('Objet flashcard ignoré:', match);
                                    }
                                }
                                if (flashcards.length < 5) {
                                    throw new Error('Pas assez de flashcards valides');
                                }
                            } else {
                                throw new Error('Impossible de récupérer les flashcards');
                            }
                        } catch (regexError) {
                            throw new Error('Génération échouée - JSON invalide');
                        }
                    }

                    currentFlashcardIndex = 0;
                    flashcardsGenerated = true;

                    loadingElement.style.display = 'none';
                    flashcardElement.style.display = 'block';
                    navElement.style.display = 'flex';

                    updateFlashcard();

                } catch (error) {
                    console.error('Erreur génération flashcards:', error);
                    let errorMsg = 'Erreur lors de la génération des flashcards.';
                    
                    if (error.message.includes('429')) {
                        errorMsg = 'Limite de requêtes atteinte. Attendez quelques minutes avant de réessayer.';
                    } else if (error.message.includes('JSON')) {
                        errorMsg = 'Erreur de format. Essayez de relancer la génération.';
                    }
                    
                    loadingElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${errorMsg} <br><small>Cliquez sur l'onglet Flashcards pour réessayer.</small>`;
                }
            }
            
            async function callOllamaForFlashcards(prompt) {
                const response = await fetch('http://localhost:11434/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "llama3.1",
                        messages: [{ role: "user", content: prompt }],
                        stream: false,
                        options: {
                            temperature: 0.9,
                            top_p: 0.9,
                            seed: Math.floor(Math.random() * 10000)
                        }
                    })
                });
                
                if (!response.ok) throw new Error(`Erreur Ollama: ${response.status}`);
                const data = await response.json();
                return data.message.content;
            }
            
            async function callGroqForFlashcards(prompt) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 45000);
                
                try {
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer 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`
                        },
                        body: JSON.stringify({
                            model: 'llama3-8b-8192',
                            messages: [{ role: "user", content: prompt }],
                            max_tokens: 6000,
                            temperature: 0.3,
                            top_p: 0.130
                        }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        if (response.status === 429) {
                            throw new Error('Erreur Groq: 429 - Limite de taux atteinte');
                        }
                        throw new Error(`Erreur Groq: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    clearTimeout(timeoutId);
                    throw error;
                }
            }
            
            // Gestion du changement de niveau
            levelSelect.addEventListener('change', function() {
                const selectedLevel = this.value;
                subjectSelect.innerHTML = '<option value="">Sélectionnez une matière</option>';
                
                if (selectedLevel && subjectsByLevel[selectedLevel]) {
                    subjectSelect.disabled = false;
                    subjectsByLevel[selectedLevel].forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject.value;
                        option.textContent = subject.text;
                        subjectSelect.appendChild(option);
                    });
                } else {
                    subjectSelect.disabled = true;
                }
                savePreferences();
            });
            
            // Sauvegarder lors des changements
            subjectSelect.addEventListener('change', savePreferences);
            chapterInput.addEventListener('input', savePreferences);
            optionSelect.addEventListener('change', savePreferences);
            
            // Démarrer la conversation
            startBtn.addEventListener('click', function() {
                const level = levelSelect.value;
                const subject = subjectSelect.value;
                const chapter = chapterInput.value.trim();
                const option = optionSelect.value;
                
                if (!level || !subject || !chapter || !option) {
                    alert('Veuillez remplir tous les champs');
                    return;
                }
                
                // Mettre à jour le contexte actuel
                currentContext = {
                    level,
                    subject,
                    chapter,
                    option
                };
                
                // Mettre à jour le titre du chat
                const levelText = levelSelect.options[levelSelect.selectedIndex].text;
                const subjectText = subjectSelect.options[subjectSelect.selectedIndex].text;
                const optionText = optionSelect.options[optionSelect.selectedIndex].text;
                if (chatTitle) {
                    chatTitle.textContent = `${levelText} - ${subjectText} - ${chapter}`;
                }
                
                // Activer la zone de chat
                userInput.disabled = false;
                sendBtn.disabled = false;
                
                // Générer le premier message basé sur la sélection
                generateInitialMessage(level, subject, chapter, option);
                
                // Régénérer automatiquement les flashcards pour le nouveau sujet
                flashcards = [];
                currentFlashcardIndex = 0;
                flashcardsGenerated = false;
                
                // Si on est sur l'onglet flashcard, regénérer immédiatement
                if (flashcardTab.classList.contains('active')) {
                    generateFlashcards();
                }
                

            });
            
            // Envoyer un message
            sendBtn.addEventListener('click', sendMessage);
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            function generateInitialMessage(level, subject, chapter, option) {
                let userMessage = "";
                let apiMessage = "";

                // Déterminer la matière en français pour le rôle
                const subjectNames = {
                    'mathematiques': 'mathématiques',
                    'francais': 'français',
                    'histoire_geographie': 'histoire-géographie',
                    'anglais': 'anglais',
                    'svt': 'SVT (sciences de la vie et de la Terre)',
                    'physique_chimie': 'physique-chimie',
                    'technologie': 'technologie',
                    'arts_plastiques': 'arts plastiques',
                    'education_musicale': 'éducation musicale',
                    'eps': 'EPS',
                    'ses': 'SES (sciences économiques et sociales)',
                    'enseignement_scientifique': 'enseignement scientifique',
                    'philosophie': 'philosophie',
                    'specialite_mathematiques': 'mathématiques (spécialité)',
                    'specialite_physique_chimie': 'physique-chimie (spécialité)',
                    'specialite_svt': 'SVT (spécialité)',
                    'specialite_ses': 'SES (spécialité)',
                    'specialite_hggsp': 'HGGSP (spécialité)',
                    'specialite_hlp': 'HLP (spécialité)',
                    'specialite_llcer': 'LLCER (spécialité)',
                    'specialite_nsi': 'NSI (spécialité)'
                };
                
                const subjectName = subjectNames[subject] || subject;
                const levelText = levelSelect.options[levelSelect.selectedIndex].text;

                // Message affiché à l'utilisateur
                switch(option) {
                    case 'comprendre':
                        userMessage = `Peux-tu m'expliquer le chapitre "${chapter}" en ${subjectName} pour un niveau ${levelText} ? J'aimerais comprendre les concepts clés.`;
                        break;
                    case 'devoir':
                        userMessage = `J'ai besoin d'aide pour un devoir sur le chapitre "${chapter}" en ${subjectName} (niveau ${levelText}).`;
                        break;
                    case 'exercice':
                        userMessage = `Peux-tu me proposer des exercices supplémentaires sur le chapitre "${chapter}" en ${subjectName} pour un niveau ${levelText} ?`;
                        break;
                    case 'revision':
                        userMessage = `J'aimerais réviser le chapitre "${chapter}" en ${subjectName} (niveau ${levelText}). Peux-tu me faire un résumé ?`;
                        break;
                    case 'explication':
                        userMessage = `Pourrais-tu m'expliquer en détail le chapitre "${chapter}" en ${subjectName} pour un niveau ${levelText} ?`;
                        break;
                    default:
                        userMessage = `J'aimerais discuter du chapitre "${chapter}" en ${subjectName} (niveau ${levelText}).`;
                }
                
                // Sources officielles spécifiques pour Terminale
                let officialSources = "";
                if (level === 'terminale') {
                    const terminaleSources = {
                        'enseignement_scientifique': 'Programme officiel: https://www.education.gouv.fr/sites/default/files/ensel807_annexe.pdf',
                        'histoire_geographie': 'Programme officiel: https://eduscol.education.fr/document/23416/download',
                        'specialite_mathematiques': 'Programme officiel: https://eduscol.education.fr/document/24568/download',
                        'philosophie': 'Programme officiel: https://eduscol.education.fr/document/24043/download',
                        'specialite_physique_chimie': 'Programme officiel: https://eduscol.education.fr/document/22669/download',
                        'anglais': 'Programme officiel: https://www.education.gouv.fr/sites/default/files/ensel621_annexe4.pdf',
                        'allemand': 'Programme officiel: https://www.education.gouv.fr/sites/default/files/ensel621_annexe2_ok.pdf'
                    };
                    
                    if (terminaleSources[subject]) {
                        officialSources = `\n\nSOURCES OBLIGATOIRES pour Terminale ${subjectName}:\n- ${terminaleSources[subject]}\n- Cours fiables: https://www.digischool.fr/lycee/terminale-generale et https://www.lelivrescolaire.fr/\n- Quiz Lumni: https://www.lumni.fr/lycee/terminale/tous-les-quiz`;
                    } else {
                        officialSources = `\n\nSOURCES FIABLES UNIQUEMENT:\n- Programme EMC: https://eduscol.education.fr/document/23707/download\n- Cours: https://www.digischool.fr/lycee/terminale-generale et https://www.lelivrescolaire.fr/\n- Quiz: https://www.lumni.fr/lycee/terminale/tous-les-quiz`;
                    }
                }
                
                // Message avec rôle de professeur renforcé pour l'API
                let roleInstruction = `Tu es un professeur agrégé de ${subjectName}, spécialiste du niveau ${levelText} avec 20 ans d'expérience. Tu maîtrises parfaitement le programme officiel de l'Éducation nationale française et les attendus pédagogiques de ce niveau.`;
                
                let strictSourceInstructions = "";
                if (level === 'terminale') {
                    strictSourceInstructions = `\n\nEXIGENCE ABSOLUE DE SOURCES OFFICIELLES:\n- Tu dois te baser UNIQUEMENT sur les programmes officiels du Ministère de l'Education et les sources institutionnelles listées\n- INTERDICTION FORMELLE d'inventer, reformuler de manière hasardeuse ou utiliser des sources non-officielles\n- Toute information doit être vérifiable dans les documents officiels\n- En cas de doute sur une information, indique "information non confirmée dans les sources officielles" plutôt que de risquer une erreur\n- Respecte scrupuleusement la terminologie et les définitions des programmes officiels`;
                }
                
                let accuracyInstructions = `EXIGENCE ABSOLUE DE PRECISION: Vérifie mentalement chaque fait, date, nom propre et événement avant de l'écrire. En cas de doute sur une information, précise "selon les sources officielles" ou omets l'information plutôt que de risquer une erreur. Ne JAMAIS confondre les époques, les personnages ou les événements.`;
                
                let contextualInstructions = "";
                if (subject.includes('histoire') || subject.includes('geographie')) {
                    contextualInstructions = `ATTENTION PARTICULIERE HISTOIRE: 1) Respecte scrupuleusement la chronologie - vérifie l'ordre des événements, 2) Ne confonds JAMAIS les époques (ex: Première vs Seconde Guerre mondiale), 3) Utilise EXCLUSIVEMENT la terminologie française ("Axe" pas "Axis", "Alliés" pas "Allies"), 4) Vérifie les dates précises des traités, pactes et accords AVANT de mentionner leurs conséquences, 5) Contextualise chaque événement dans sa période exacte avec les bonnes dates, 6) Utilise UNIQUEMENT les informations du programme officiel Eduscol.`;
                } else if (subject.includes('mathematiques') || subject.includes('physique') || subject.includes('scientifique')) {
                    contextualInstructions = `RIGUEUR SCIENTIFIQUE: Vérifie chaque formule, théorème et propriété mathématique selon les programmes officiels. Utilise la syntaxe LaTeX correcte: $a_n$ pour indices, $a^n$ pour exposants, $$formule$$ pour formules centrées. Explique chaque étape de calcul selon les méthodes du programme officiel.`;
                } else if (subject.includes('philosophie')) {
                    contextualInstructions = `PRECISION PHILOSOPHIQUE: Respecte scrupuleusement les notions du programme officiel, les auteurs au programme et leurs concepts exacts. Utilise exclusivement la terminologie philosophique validée par les programmes Eduscol.`;
                }
                
                let langInstruction = currentLanguage === 'fr' ? "Réponds EXCLUSIVEMENT en français." : "Always respond in English.";
                
                let formatInstructions = `Structure pédagogique OBLIGATOIRE: Utilise des titres clairs (**Titre**), des listes à puces (* item), et de l'italique (_terme important_) pour faciliter la compréhension.`;
                
                let pedagogyInstructions = `Méthode pédagogique: 1) Explique clairement les concepts selon le programme officiel, 2) Donne des exemples concrets validés par les sources officielles, 3) Fais des liens avec le programme officiel uniquement, 4) Adapte le vocabulaire au niveau scolaire, 5) Termine par une section **Sources officielles consultées** avec les références institutionnelles utilisées.`;
                
                apiMessage = `${roleInstruction}${strictSourceInstructions}\n\n${accuracyInstructions}\n\n${contextualInstructions}\n\n${langInstruction} ${formatInstructions}\n\n${pedagogyInstructions}${officialSources}\n\nQuestion de l'élève: ${userMessage}`;
                
                // Ajouter le message complet à l'historique pour l'API
                conversationHistory.push({ role: "user", content: apiMessage });
                
                // Afficher seulement le message utilisateur (sans les instructions)
                displayMessage(userMessage, 'user');
                
                // Appeler l'API
                callAI();
            }
            
            function sendMessage() {
                const message = userInput.value.trim();
                if (!message) return;

                // Construire le message avec le contexte du professeur
                const subjectNames = {
                    'mathematiques': 'mathématiques',
                    'francais': 'français',
                    'histoire_geographie': 'histoire-géographie',
                    'anglais': 'anglais',
                    'svt': 'SVT',
                    'physique_chimie': 'physique-chimie',
                    'ses': 'SES',
                    'philosophie': 'philosophie'
                };
                
                const subjectName = subjectNames[currentContext.subject] || currentContext.subject;
                const levelText = currentContext.level;
                
                let contextInstruction = `En tant que professeur agrégé de ${subjectName} niveau ${levelText}, réponds avec une PRECISION ABSOLUE à cette question sur "${currentContext.chapter}". Vérifie mentalement chaque fait avant de l'écrire.`;
                
                let accuracyReminder = "RAPPEL CRITIQUE: Aucune erreur factuelle n'est tolérée. En cas de doute, précise \"selon certaines sources\" ou omets l'information.";
                
                let formatInstruction = "";
                if (currentContext.subject.includes('mathematiques') || currentContext.subject.includes('physique_chimie') || currentContext.subject === 'enseignement_scientifique') {
                    formatInstruction = " Utilise la syntaxe LaTeX correcte pour les formules ($...$ inline, $$...$$ bloc). Vérifie chaque formule.";
                } else if (currentContext.subject.includes('histoire') || currentContext.subject.includes('geographie')) {
                    formatInstruction = " ATTENTION HISTOIRE: Respecte la chronologie exacte, utilise la terminologie française (\"Axe\" pas \"Axis\"), vérifie les dates des traités/pactes, ne confonds jamais les époques.";
                }
                
                let sourceInstruction = " Termine par **Sources recommandées** avec références institutionnelles fiables.";
                
                let messageForAI = `${contextInstruction}\n\n${accuracyReminder}${formatInstruction}${sourceInstruction}\n\nQuestion: ${message}`;

                // Ajouter le message à l'historique
                conversationHistory.push({ role: "user", content: messageForAI });

                // Afficher le message de l'utilisateur (sans les instructions)
                displayMessage(message, 'user');

                // Effacer le champ de saisie
                userInput.value = '';

                // Appeler l'API
                callAI();
            }
            
            function displayMessage(message, sender) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message');
                messageElement.classList.add(sender === 'user' ? 'user-message' : 'ai-message');
                
                // Traitement avancé du message avec formatage Markdown
                let processedMessage = formatMessage(message);
                
                messageElement.innerHTML = processedMessage;

                const messageInfo = document.createElement('div');
                messageInfo.classList.add('message-info');
                const t = translations[currentLanguage];
                const assistantName = apiMode === 'groq' ? 'Llama 3 (Groq)' : t.assistantName;
                messageInfo.textContent = sender === 'user' ? t.you : assistantName;

                // Ajouter contrôles pour les messages IA
                if (sender === 'ai') {
                    // Bouton copie
                    const copyBtn = document.createElement('button');
                    copyBtn.classList.add('copy-btn');
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                    copyBtn.title = 'Copier le texte';
                    copyBtn.onclick = () => copyMessage(message, copyBtn);
                    messageInfo.appendChild(copyBtn);
                    
                    // Bouton lecture
                    const speakBtn = document.createElement('button');
                    speakBtn.classList.add('speak-btn');
                    speakBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                    speakBtn.title = 'Écouter la réponse';
                    speakBtn.onclick = () => toggleSpeech(message, speakBtn);
                    messageInfo.appendChild(speakBtn);
                    
                    // Contrôles vocaux simples
                    const voiceControls = document.createElement('div');
                    voiceControls.classList.add('voice-controls');
                    voiceControls.innerHTML = `
                        <button class="voice-btn pause-btn" title="Pause">
                            <i class="fas fa-pause"></i>
                        </button>
                        <button class="voice-btn stop-btn" title="Stop">
                            <i class="fas fa-stop"></i>
                        </button>
                        <input type="range" class="speed-control" min="0.5" max="2" step="0.1" value="1.0" title="Vitesse">
                        <span class="speed-display">1.0x</span>
                    `;
                    messageInfo.appendChild(voiceControls);
                }

                messageElement.appendChild(messageInfo);
                chatMessages.appendChild(messageElement);
                // Ne pas scroller automatiquement pour rester en haut

                // Rendu MathJax avec gestion d'erreur
                setTimeout(() => {
                    if (window.MathJax && window.MathJax.typesetPromise) {
                        window.MathJax.typesetPromise([messageElement]).catch((err) => {
                            console.warn('Erreur MathJax:', err);
                        });
                    }
                }, 100);
            }
            
            function formatMessage(message) {
                // Corriger d'abord les problèmes d'encodage et LATEXBLOCK
                let processedMessage = message
                    // Corriger les accents corrompus
                    .replace(/spcialit/g, 'spécialité')
                    .replace(/mathmatiques/g, 'mathématiques')
                    .replace(/Dfinitions/g, 'Définitions')
                    .replace(/polynme/g, 'polynôme')
                    .replace(/Proprits/g, 'Propriétés')
                    .replace(/drivable/g, 'dérivable')
                    .replace(/drive/g, 'dérivée')
                    .replace(/cls/g, 'clés')
                    .replace(/expliqus/g, 'expliqués')
                    .replace(/rels/g, 'réels')
                    // Supprimer les références LATEXBLOCK corrompues
                    .replace(/_?LATEXBLOCK\d+_?/g, '')
                    .replace(/où\s+et\s+\./g, '.')
                    .replace(/où\s+\./g, '.')
                    .replace(/\s+\./g, '.')
                    // Nettoyer les phrases cassées
                    .replace(/une fonction du type\s*,/g, 'une fonction')
                    .replace(/sont des\s*et\s*\./g, 'sont des polynômes.')
                    .replace(/\s+sont des\s*\./g, ' sont définis.')
                    // Corriger les espaces multiples
                    .replace(/\s{2,}/g, ' ')
                    .replace(/\n{3,}/g, '\n\n');
                
                // Protéger les vraies formules LaTeX restantes
                let latexBlocks = [];
                processedMessage = processedMessage.replace(/(\$\$[\s\S]+?\$\$|\$[^$]+\$)/g, function(match) {
                    latexBlocks.push(match);
                    return `__LATEX_BLOCK_${latexBlocks.length - 1}__`;
                });
                
                // Traitement Markdown avancé
                processedMessage = processedMessage
                    // Grands titres
                    .replace(/^#{1,2}\s+(.+)$/gm, '<h1>$1</h1>')
                    // Titres moyens
                    .replace(/^\*\*([^*\n]+)\*\*\s*:?\s*$/gm, '<h2>$1</h2>')
                    // Sous-titres avec deux-points
                    .replace(/^([A-ZÀ-ÿ][^<>\n]*?)\s*:\s*$/gm, '<h3>$1</h3>')
                    // Gras
                    .replace(/\*\*([^*\n]+)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*([^*\n]+)\*/g, '<strong>$1</strong>')
                    // Italique (protéger les underscores dans les mots)
                    .replace(/(?<!\w)_([^_\n]+)_(?!\w)/g, '<em>$1</em>')
                    // Listes à puces
                    .replace(/^[+*-]\s+(.+)$/gm, '<li>$1</li>')
                    // Code inline
                    .replace(/`([^`]+)`/g, '<code>$1</code>');
                
                // Convertir sauts de ligne
                processedMessage = processedMessage
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>');
                
                // Envelopper dans paragraphes
                if (!processedMessage.startsWith('<h') && !processedMessage.startsWith('<p>')) {
                    processedMessage = '<p>' + processedMessage + '</p>';
                }
                
                // Traitement des listes
                processedMessage = processedMessage.replace(/(<li>.*?<\/li>)/gs, '<ul>$1</ul>');
                
                // Nettoyage final
               
                processedMessage = processedMessage
                    .replace(/<\/ul>(<br>)*<ul>/g, '')
                    .replace(/<br><\/p>/g, '</p>')
                    .replace(/<p><br>/g, '<p>')
                    .replace(/<br>(<h[123]>)/g, '$1')
                    .replace(/(<\/h[123]>)<br>/g, '$1')
                    .replace(/<p><\/p>/g, '')
                    .replace(/<p>\s*<\/p>/g, '')
                    // Nettoyer autour des formules LaTeX
                    .replace(/<br>\$\$/g, '$$')
                    .replace(/\$\$<br>/g, '$$')
                    .replace(/<br>\$/g, '$')
                    .replace(/\$<br>/g, '$');
                
                // Restaurer les blocs LaTeX
                processedMessage = processedMessage.replace(/__LATEX_BLOCK_(\d+)__/g, function(_, i) {
                    return latexBlocks[i] || '';
                });

                return processedMessage;
            }
            
            async function callAI() {
                if (!loading) {
                    console.error('Élément loading non trouvé');
                    return;
                }
                
                loading.style.display = 'block';
                console.log('Mode API actuel:', apiMode);
                
                try {
                    let response;
                    
                    if (apiMode === 'ollama') {
                        console.log('Appel Ollama...');
                        response = await callOllama();
                    } else if (apiMode === 'groq') {
                        console.log('Appel Groq...');
                        response = await callGroq();
                    } else {
                        throw new Error('Mode API non reconnu: ' + apiMode);
                    }
                    
                    if (response && response.trim()) {
                        conversationHistory.push({ role: "assistant", content: response });
                        displayMessage(response, 'ai');
                    } else {
                        throw new Error('Réponse vide reçue');
                    }
                    
                } catch (error) {
                    console.error('Erreur détaillée dans callAI:', error);
                    let errorMessage = `Désolé, je rencontre un problème technique: ${error.message}`;
                    
                    if (error.message.includes('Groq')) {
                        errorMessage = `Erreur avec Groq: ${error.message}`;
                    } else if (error.message.includes('Ollama')) {
                        errorMessage = `Erreur avec Ollama: ${error.message}`;
                    }
                    
                    conversationHistory.push({ role: "assistant", content: errorMessage });
                    displayMessage(errorMessage, 'ai');
                } finally {
                    if (loading) {
                        loading.style.display = 'none';
                    }
                }
            }
            
            async function callOllama() {
                const messages = conversationHistory.map(msg => ({
                    role: msg.role,
                    content: msg.content
                }));
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 secondes pour Ollama
                
                try {
                    const response = await fetch('http://localhost:11434/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: "llama3.1",
                            messages: messages,
                            stream: false
                        }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erreur Ollama (${response.status}): ${errorText}`);
                    }
                    
                    const data = await response.json();
                    if (!data.message || !data.message.content) {
                        throw new Error('Format de réponse Ollama invalide');
                    }
                    
                    return data.message.content;
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('Timeout: Ollama met trop de temps à répondre');
                    }
                    throw error;
                }
            }
            

            

            

            
            let currentUtterance = null;
            let currentSpeechRate = 1.0;
            let isPaused = false;
            
            function copyMessage(message, button) {
                const cleanText = message
                    .replace(/<[^>]*>/g, '')
                    .replace(/\$\$[^$]*\$\$/g, '[formule mathématique]')
                    .replace(/\$[^$]*\$/g, '[formule]')
                    .replace(/\*\*([^*]+)\*\*/g, '$1')
                    .replace(/\*([^*]+)\*/g, '$1')
                    .replace(/_{1,2}([^_]+)_{1,2}/g, '$1')
                    .replace(/\s+/g, ' ')
                    .trim();
                
                navigator.clipboard.writeText(cleanText).then(() => {
                    const originalHTML = button.innerHTML;
                    button.classList.add('copied');
                    button.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        button.classList.remove('copied');
                        button.innerHTML = originalHTML;
                    }, 2000);
                }).catch(() => {
                    alert('Impossible de copier le texte');
                });
            }
            
            function toggleSpeech(message, button) {
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                    isPaused = false;
                    document.querySelectorAll('.speak-btn').forEach(btn => {
                        btn.classList.remove('speaking');
                        btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                    });
                    document.querySelectorAll('.voice-controls').forEach(ctrl => {
                        ctrl.classList.remove('active');
                    });
                    return;
                }
                speakMessage(message, button);
            }
            
            // Gestionnaire d'événements pour les contrôles vocaux
            document.addEventListener('click', (e) => {
                if (e.target.closest('.pause-btn')) {
                    if (speechSynthesis.speaking && !isPaused) {
                        speechSynthesis.pause();
                        isPaused = true;
                        e.target.closest('.pause-btn').innerHTML = '<i class="fas fa-play"></i>';
                        e.target.closest('.pause-btn').title = 'Reprendre';
                    } else if (isPaused) {
                        speechSynthesis.resume();
                        isPaused = false;
                        e.target.closest('.pause-btn').innerHTML = '<i class="fas fa-pause"></i>';
                        e.target.closest('.pause-btn').title = 'Pause';
                    }
                }
                
                if (e.target.closest('.stop-btn')) {
                    speechSynthesis.cancel();
                    isPaused = false;
                    document.querySelectorAll('.speak-btn').forEach(btn => {
                        btn.classList.remove('speaking');
                        btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                    });
                    document.querySelectorAll('.voice-controls').forEach(ctrl => {
                        ctrl.classList.remove('active');
                    });
                    document.querySelectorAll('.pause-btn').forEach(btn => {
                        btn.innerHTML = '<i class="fas fa-pause"></i>';
                        btn.title = 'Pause';
                    });
                }
            });
            
            // Gestionnaire pour le contrôle de vitesse
            document.addEventListener('input', (e) => {
                if (e.target.classList.contains('speed-control')) {
                    const speed = e.target.value;
                    currentSpeechRate = parseFloat(speed);
                    const display = e.target.parentElement.querySelector('.speed-display');
                    if (display) display.textContent = speed + 'x';
                }
            });
            
            function speakMessage(message, button) {
                let cleanText = message
                    .replace(/<[^>]*>/g, ' ')
                    .replace(/\$\$[^$]*\$\$/g, ' formule mathématique ')
                    .replace(/\$[^$]*\$/g, ' formule ')
                    .replace(/\*\*([^*]+)\*\*/g, '$1')
                    .replace(/\*([^*]+)\*/g, '$1')
                    .replace(/_{1,2}([^_]+)_{1,2}/g, '$1')
                    .replace(/\s+/g, ' ')
                    .trim();

                speechSynthesis.cancel();
                isPaused = false;
                document.querySelectorAll('.speak-btn').forEach(btn => {
                    btn.classList.remove('speaking');
                    btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                });
                document.querySelectorAll('.voice-controls').forEach(ctrl => {
                    ctrl.classList.remove('active');
                });
                document.querySelectorAll('.pause-btn').forEach(btn => {
                    btn.innerHTML = '<i class="fas fa-pause"></i>';
                    btn.title = 'Pause';
                });

                button.classList.add('speaking');
                button.innerHTML = '<i class="fas fa-stop"></i>';
                
                // Afficher les contrôles vocaux
                const voiceControls = button.parentElement.querySelector('.voice-controls');
                if (voiceControls) voiceControls.classList.add('active');
                
                const utterance = new SpeechSynthesisUtterance(cleanText);
                
                // Attendre que les voix soient chargées
                const speakWithBestVoice = () => {
                    const voices = speechSynthesis.getVoices();
                    
                    // Recherche des meilleures voix par priorité
                    const voicePreferences = currentLanguage === 'fr' ? [
                        'Google français',
                        'Microsoft Hortense',
                        'Microsoft Julie',
                        'Amelie',
                        'Thomas'
                    ] : [
                        'Google UK English Female',
                        'Google US English',
                        'Microsoft Zira',
                        'Microsoft Hazel',
                        'Samantha',
                        'Karen'
                    ];
                    
                    let selectedVoice = null;
                    
                    // Chercher la meilleure voix disponible
                    for (const pref of voicePreferences) {
                        selectedVoice = voices.find(voice => 
                            voice.name.toLowerCase().includes(pref.toLowerCase())
                        );
                        if (selectedVoice) break;
                    }
                    
                    // Fallback sur n'importe quelle voix de la bonne langue
                    if (!selectedVoice) {
                        selectedVoice = voices.find(voice => 
                            currentLanguage === 'fr' ? 
                                voice.lang.includes('fr') : 
                                voice.lang.includes('en')
                        );
                    }
                    
                    if (selectedVoice) {
                        utterance.voice = selectedVoice;
                        console.log('Voix sélectionnée:', selectedVoice.name);
                    }
                    
                    utterance.lang = currentLanguage === 'fr' ? 'fr-FR' : 'en-US';
                    utterance.rate = currentSpeechRate;
                    utterance.pitch = 1.1;
                    utterance.volume = 1.0;
                    
                    currentUtterance = utterance;
                    
                    utterance.onend = () => {
                        button.classList.remove('speaking');
                        button.innerHTML = '<i class="fas fa-volume-up"></i>';
                        const voiceControls = button.parentElement.querySelector('.voice-controls');
                        if (voiceControls) voiceControls.classList.remove('active');
                        currentUtterance = null;
                        isPaused = false;
                        document.querySelectorAll('.pause-btn').forEach(btn => {
                            btn.innerHTML = '<i class="fas fa-pause"></i>';
                            btn.title = 'Pause';
                        });
                    };
                    
                    utterance.onerror = () => {
                        button.classList.remove('speaking');
                        button.innerHTML = '<i class="fas fa-volume-up"></i>';
                        const voiceControls = button.parentElement.querySelector('.voice-controls');
                        if (voiceControls) voiceControls.classList.remove('active');
                        currentUtterance = null;
                        isPaused = false;
                        document.querySelectorAll('.pause-btn').forEach(btn => {
                            btn.innerHTML = '<i class="fas fa-pause"></i>';
                            btn.title = 'Pause';
                        });
                    };
                    
                    speechSynthesis.speak(utterance);
                };
                
                if (speechSynthesis.getVoices().length === 0) {
                    speechSynthesis.onvoiceschanged = speakWithBestVoice;
                } else {
                    speakWithBestVoice();
                }
            }
            
            // Raccourcis clavier
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.key === ' ') {
                    e.preventDefault();
                    document.querySelector('.pause-btn')?.click();
                } else if (e.ctrlKey && e.key === 'Escape') {
                    e.preventDefault();
                    document.querySelector('.stop-btn')?.click();
                }
            });

            async function callGroq() {
                const messages = conversationHistory.map(msg => ({
                    role: msg.role,
                    content: msg.content
                }));
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 secondes timeout
                
                try {
                    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer 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`
                        },
                        body: JSON.stringify({
                            model: 'llama3-8b-8192',
                            messages: messages,
                            max_tokens: 1000,
                            temperature: 0.7
                        }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erreur Groq (${response.status}): ${errorText}`);
                    }
                    
                    const data = await response.json();
                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        throw new Error('Format de réponse Groq invalide');
                    }
                    
                    return data.choices[0].message.content;
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('Timeout: La requête a pris trop de temps');
                    }
                    throw error;
                }
            }
        });
    </script>
    
    <!-- Configuration MathJax AVANT le chargement -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: true,
                processEnvironments: true,
                packages: {'[+]': ['ams', 'newcommand', 'configmacros']}
            },
            startup: {
                ready: () => {
                    console.log('MathJax est prêt');
                    MathJax.startup.defaultReady();
                }
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</body>
</html>
